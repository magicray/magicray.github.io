<!doctype html>
<html lang="en">
<head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<title>Stocks</title>
</head>
<body>
    <div class="div">
        <p id="timestamp" class="text-center"></p>
        <div id="head" class="row">
        <div class="col"></div>
        <input id="filter" type="text" class="col" placeholder="Search" style="text-align: center">
        <input id="amount" type="text" class="col" placeholder="Value in Crores" style="text-align: center">
        <div class="col"></div>
        </div>
        <table id="sold" class="table compact table-responsive table-striped table-bordered" style="white-space: nowrap">
            <thead><tr><th>Date</th><th>Stock</th></tr></thead>
        </table>
        <table id="rank" class="table compact table-responsive table-striped table-bordered" style="text-align: center; font-weight: 500;">
            <thead>
                <tr>
                <th colspan=2>Group</th>
                <th colspan=7>Stability</th>
                <th colspan=8>Quality</th>
                <th colspan=11>Growth</th>
                <th colspan=6>Valuation</th>
                </tr>
                <tr>
                <th colspan=2 id="group_buy">Buy</th>
                <th id="ev_green"></th>
                <th id="mcap_green"></th>
                <th id="net_worth_green"></th>
                <th id="sales_green"></th>
                <th id="profit_green"></th>
                <th id="oprofit_green"></th>
                <th id="ebit_green"></th>
                <th id="roce_green"></th>
                <th id="roce_3yr_green"></th>
                <th id="roce_5yr_green"></th>
                <th id="roe_green"></th>
                <th id="roe_3yr_green"></th>
                <th id="roe_5yr_green"></th>
                <th id="opm_green"></th>
                <th id="opm_5yr_green"></th>
                <th id="profit_growth_yoy_green"></th>
                <th id="profit_growth_green"></th>
                <th id="profit_growth_3yr_green"></th>
                <th id="profit_growth_5yr_green"></th>
                <th id="sales_growth_yoy_green"></th>
                <th id="sales_growth_green"></th>
                <th id="sales_growth_3yr_green"></th>
                <th id="sales_growth_5yr_green"></th>
                <th id="oprofit_growth_green"></th>
                <th id="eps_growth_3yr_green"></th>
                <th id="eps_growth_5yr_green"></th>
                <th id="yield_green"></th>
                <th id="pe_green"></th>
                <th id="ps_green"></th>
                <th id="pb_green"></th>
                <th id="po_green"></th>
                <th id="evebitda_green"></th>
                </tr><tr>
                <th colspan=2 id="group_all">All</th>
                <th id="ev_black"></th>
                <th id="mcap_black"></th>
                <th id="net_worth_black"></th>
                <th id="sales_black"></th>
                <th id="profit_black"></th>
                <th id="oprofit_black"></th>
                <th id="ebit_black"></th>
                <th id="roce_black"></th>
                <th id="roce_3yr_black"></th>
                <th id="roce_5yr_black"></th>
                <th id="roe_black"></th>
                <th id="roe_3yr_black"></th>
                <th id="roe_5yr_black"></th>
                <th id="opm_black"></th>
                <th id="opm_5yr_black"></th>
                <th id="profit_growth_yoy_black"></th>
                <th id="profit_growth_black"></th>
                <th id="profit_growth_3yr_black"></th>
                <th id="profit_growth_5yr_black"></th>
                <th id="sales_growth_yoy_black"></th>
                <th id="sales_growth_black"></th>
                <th id="sales_growth_3yr_black"></th>
                <th id="sales_growth_5yr_black"></th>
                <th id="oprofit_growth_black"></th>
                <th id="eps_growth_3yr_black"></th>
                <th id="eps_growth_5yr_black"></th>
                <th id="yield_black"></th>
                <th id="pe_black"></th>
                <th id="ps_black"></th>
                <th id="pb_black"></th>
                <th id="po_black"></th>
                <th id="evebitda_black"></th>
                </tr><tr>
                <th colspan=2 id="group_sell">Sell</th>
                <th id="ev_red"></th>
                <th id="mcap_red"></th>
                <th id="net_worth_red"></th>
                <th id="sales_red"></th>
                <th id="profit_red"></th>
                <th id="oprofit_red"></th>
                <th id="ebit_red"></th>
                <th id="roce_red"></th>
                <th id="roce_3yr_red"></th>
                <th id="roce_5yr_red"></th>
                <th id="roe_red"></th>
                <th id="roe_3yr_red"></th>
                <th id="roe_5yr_red"></th>
                <th id="opm_red"></th>
                <th id="opm_5yr_red"></th>
                <th id="profit_growth_yoy_red"></th>
                <th id="profit_growth_red"></th>
                <th id="profit_growth_3yr_red"></th>
                <th id="profit_growth_5yr_red"></th>
                <th id="sales_growth_yoy_red"></th>
                <th id="sales_growth_red"></th>
                <th id="sales_growth_3yr_red"></th>
                <th id="sales_growth_5yr_red"></th>
                <th id="oprofit_growth_red"></th>
                <th id="eps_growth_3yr_red"></th>
                <th id="eps_growth_5yr_red"></th>
                <th id="yield_red"></th>
                <th id="pe_red"></th>
                <th id="ps_red"></th>
                <th id="pb_red"></th>
                <th id="po_red"></th>
                <th id="evebitda_red"></th>
                </tr><tr style="position: sticky; top: 0; z-index: 10; background-color: white">
                <th>Rank</th>
                <th>Stock</th>
                <th>EV</th>
                <th>MCap</th>
                <th>Networth</th>
                <th>Sales</th>
                <th>Profit</th>
                <th>OProfit</th>
                <th>EBIT</th>
                <th>ROCE</th>
                <th>ROCE 3Yr</th>
                <th>ROCE 5Yr</th>
                <th>ROE</th>
                <th>ROE 3Yr</th>
                <th>ROE 5Yr</th>
                <th>OPM</th>
                <th>OPM 5Yr</th>
                <th>Profit Qtr</th>
                <th>Profit 1Yr</th>
                <th>Profit 3Yr</th>
                <th>Profit 5Yr</th>
                <th>Sales Qtr</th>
                <th>Sales 1Yr</th>
                <th>Sales 3Yr</th>
                <th>Sales 5Yr</th>
                <th>OProfit</th>
                <th>EPS 3Yr</th>
                <th>EPS 5Yr</th>
                <th>Earnings Yield</th>
                <th>PE</th>
                <th>PS</th>
                <th>PB</th>
                <th>PO</th>
                <th>EVEBITDA</th>
                </tr>
            </thead>
        </table>
    </div>
</body>
<script>
const G = {}

fetch('https://magicray.github.io/magicrank.json').then(function(response) {
    response.json().then(function(data) {
        G.data = data

        const age = Math.floor((Date.now() / 1000 - data['date'])/3600)
        const total = G.data['data'].length
	const sell_date = new Date(Math.max(...Object.values(data['sold']))*1000).toJSON()
         $('#timestamp').html(
            '<a href="' + data['url'] + '" target="_blank">Quality-Growth-Value-Stability</a> - ' +
            'Refreshed <a href="">' + age + ' hours</a> ago - ' +
            '<a href="#sold">Recently Sold</a>')

        const names = data['data'].map(obj => obj['name'])

        const sold = {}
        Object.keys(data['sold']).map(function(k) {
            today = new Date(data['sold'][k]*1000)
            next_sunday = data['sold'][k] + (7 - today.getDay()) * 86400

            if(today.getDay() > 0 && new Date(next_sunday*1000) <= new Date())
                today = new Date(next_sunday*1000)
            else
                today = new Date(data['sold'][k]*1000)

            const v = today.toJSON().substr(0, 10) + " " + today.toString().substr(0, 4)
            if(sold[v] == undefined)
                sold[v] = []

            if(names.includes(k))
                sold[v].push(k)
            else
                sold[v].push('<strong>' + k + '</strong>')

            sold[v].sort()
        })

        $('#sold').dataTable({bPaginate: false, info: false,
            order: [[0, 'desc']],
            data: Object.keys(sold).map(
                k => [k, sold[k].join('<br>')])
        })

        hashchange()
    })
})

function format_data(data, amount) {
    const result = []

    count = data.length
    buy_end_index = Math.floor(data.length/2)
    stock_count = Math.floor(data.length/2)

    for(let i=0; i<count; i++) {
        const d = data[i]
        const cmp = d['cmp_rs']
        const qty = amount? Math.ceil(amount/(stock_count*cmp)): ''

        const name = d['name'].replaceAll('.', '')
        const name_html = '<div class="text-nowrap">' + name +
                          '<small> - ' + cmp +
                          ((amount>0) && (i<stock_count)? ' * ' + qty: '') +
                          '</small></div>'

        result.push([
            d['rank'],
            name_html,
            d['ev_rs_cr'],
            d['mar_cap_rs_cr'],
            d['net_worth_rs_cr'],
            d['sales_rs_cr'],
            d['np_12m_rs_cr'],
            d['op_12m_rs_cr'],
            d['ebit_12m_rs_cr'],

            d['roce'],
            d['roce_3yr'],
            d['roce_5yr'],
            d['roe'],
            d['roe_3yr'],
            d['roe_5yr'],
            d['opm'],
            d['5yr_opm'],

            d['qtr_profit_var'],
            d['profit_growth'],
            d['profit_var_3yrs'],
            d['profit_var_5yrs'],
            d['qtr_sales_var'],
            d['sales_growth'],
            d['sales_var_3yrs'],
            d['sales_var_5yrs'],
            d['opert_prft_gwth'],
            d['eps_var_3yrs'],
            d['eps_var_5yrs'],

            d['earnings_yield'],
            d['p_e'],
            d['cmp_sales'],
            d['cmp_bv'],
            d['p_o'],
            d['ev_ebitda']])
    }

    return result
}

$('#amount').keyup(function(e) {render()})
$('#stock_count').keyup(function(e) {render()})
$('#filter').keyup(function(e) {G.rank.fnFilter(this.value)})
$(window).on('hashchange', hashchange)

function hashchange(e) {
    if('sold' == location.hash.substr(1)) {
        $('#rank').hide()
        $('#head').hide()
        $('#sold').show()
    } else {
        $('#sold').hide()
        $('#rank').show()
        $('#head').show()
        render()
    }
    $('.dataTables_filter').hide()
}

function render() {
    renderTable('rank', format_data(G.data['data'], $('#amount').val()*10**7))
    G.rank.fnFilter($('#filter').val())
    $('.dataTables_filter').hide()
}

function renderTable(tableId, data) {
    function median_index(start_index, end_index) {
        let tmp = end_index - start_index

        return {
            first: start_index + Math.floor((tmp)/2),
            second: start_index + Math.ceil((tmp)/2)
        }
    }

    let top_half = Math.floor(data.length/2);
    let data_green = data.slice(0, top_half);
    let data_red = data.slice(top_half, data.length);

    $("#group_buy").html("Buy (top " + data_green.length + ")");
    $("#group_all").html("All (" + data.length + ")");
    $("#group_sell").html("Sell (bottom " + data_red.length + ")");

    $("#group_buy").css("color", "green");
    $("#group_buy").css("font-weight", "normal");
    $("#group_all").css("font-weight", "normal");
    $("#group_sell").css("color", "red");
    $("#group_sell").css("font-weight", "normal");

    const col = ['ev', 'mcap', 'net_worth', 'sales', 'profit', 'oprofit', 'ebit',
                 'roce', 'roce_3yr', 'roce_5yr',
                 'roe', 'roe_3yr', 'roe_5yr',
                 'opm', 'opm_5yr',

	         'profit_growth_yoy', 'profit_growth', 'profit_growth_3yr', 'profit_growth_5yr',
                 'sales_growth_yoy', 'sales_growth', 'sales_growth_3yr', 'sales_growth_5yr',
                 'oprofit_growth',
                 'eps_growth_3yr', 'eps_growth_5yr',

	         'yield', 'pe', 'ps', 'pb', 'po', 'evebitda']

    col.map((name, index) => {
	let arr = data_green.map(d => d[index+2]).sort(function(a, b){ return a - b})
        let idx = median_index(0, data_green.length-1)
        $('#' + name + '_green').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_green').css('color', 'Green')
        $('#' + name + '_green').css('font-weight', 'normal')
    });

    col.map((name, index) => {
	let arr = data_red.map(d => d[index+2]).sort(function(a, b){ return a - b})
        let idx = median_index(0, data_red.length-1)
        $('#' + name + '_red').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_red').css('color', 'Red')
        $('#' + name + '_red').css('font-weight', 'normal')
    });

    col.map((name, index) => {
	let arr = data.map(d => d[index+2]).sort(function(a, b){ return a - b})
        let idx = median_index(0, arr.length-1)
        $('#' + name + '_black').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_black').css('font-weight', 'normal')
    })

    const sort_order = G.rank? G.rank.fnSettings().aaSorting[0]: [0, 'asc']
    $('#' + tableId).dataTable().fnDestroy()

    let tmp = [...data]
    tmp.map((row, index) => {
        for(let i=2; i<34; i++)
            row[i] = Math.round(row[i])
    })

    G.rank = $('#' + tableId).dataTable({bPaginate: false, data: tmp, info: false,
        order: [[sort_order[0], sort_order[1]]],
        rowCallback: function(row, d, i) {
            if(d[0] <= top_half)
                $(row).css('color', 'Green')
            if(d[0] > top_half)
                $(row).css('color', 'Red')
	}})
}
</script>
</html>

<!doctype html>
<html lang="en">
<head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<title>Stocks</title>
</head>
<body>
    <div class="div container">
        <p id="timestamp" class="text-center"></p>
        <div class="row">
        <div class="col"></div>
        <input id="count" type="text" class="col" placeholder="Stock Count">
        <input id="filter" type="text" class="col" placeholder="Search">
        <input id="amount" type="text" class="col" placeholder="Investment Amount">
        <div class="col"></div>
        </div>
        <table id="table" class="table compact table-striped table-bordered">
            <thead>
                <tr>
                <th rowspan=3>Rank</th>
                <th rowspan=3>Stock</th>
                <th colspan=2>Profitability</th>
                <th colspan=2>YoY Quarterly Growth %</th>
                <th colspan=2>Valuation</th>
                <th rowspan=3>Market Cap</th>
                </tr><tr>
                <th id="roce"></th>
                <th id="roe"></th>
                <th id="profit"></th>
                <th id="sales"></th>
                <th id="yield"></th>
                <th id="pe"></th>
                </tr><tr>
                <th>ROCE</th>
                <th>ROE</th>
                <th>Profit</th>
                <th>Sales</th>
                <th>Yield</th>
                <th>PE</th>
                </tr>
            </thead>
        </table>
    </div>
</body>
<script>
const G = {}
fetch('https://magicray.github.io/magicrank.json').then(function(response) {
    response.json().then(function(data) {
        G.data = data
        const q = new URLSearchParams(window.location.search)
        G.count = q.get('count')? q.get('count'): data['data'].length
        G.amount = q.get('amount')? q.get('amount'): 0
        G.count_default = G.count
        G.amount_default = G.amount

        $('#timestamp').html('Stocks ranked on ' +
            '<a href="https://www.screener.in/screens/415344/magicrank" target="_blank">' +
            'Profitability, Growth and Valuation</a>. Updated on ' + data['date'])

        renderTable('table', format_data(G.data['data'], G.count, G.amount))
    })
}).catch(function(err) {
    $('body').text('Could not fetch data')
})

function format_data(data, count, amount) {
    const result = []

    for(let i=0; i<count; i++) {
        const d = data[i]
        const cmp = d['cmp_rs']
        const qty = amount? Math.floor(amount/(count*cmp)): ''

        const name = '<div class="text-nowrap">' + d['name'] +
                     '<small> - ' + cmp + (amount > 0? ' * ' + qty: '') + 
                     '</small></div>'

        result.push([
            d['rank'],
            name,
            Math.floor(d['roce']),
            Math.floor(d['roe']),
            Math.floor(d['qtr_profit_var']),
            Math.floor(d['qtr_sales_var']),
            Math.floor(d['earnings_yield']),
            Math.floor(d['p_e']),
            Math.floor(d['mar_cap_rs_cr'])])
    }

    return result
}

$('#filter').keyup(function(e) {
    G.table.fnFilter(this.value)
})

$('#count').keyup(function(e) {render()})
$('#amount').keyup(function(e) {render()})

function render() {
    let count = $('#count').val()
    let amount = $('#amount').val()
    count = count? count: G.count_default
    amount = amount? amount: G.amount_default
    renderTable('table', format_data(G.data['data'], count, amount))
    G.table.fnFilter($('#filter').val())
}

function renderTable(tableId, data) {
    ['roce', 'roe', 'profit', 'sales', 'yield', 'pe'].map((name, index) => {
	let arr = data.map(d => d[index+2]).sort(function(a, b){ return a - b})
        $('#' + name).text(arr[Math.floor(arr.length/2)])
    })

    $('#' + tableId).dataTable().fnDestroy()
    G.table = $('#' + tableId).dataTable({bPaginate: false, data: data})
    $('.dataTables_filter').hide()
}
</script>
</html>

<!doctype html>
<html lang="en">
<head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<title>Stocks</title>
</head>
<body>
    <div class="div _container">
        <p id="timestamp" class="text-center"></p>
        <div id="head" class="row">
        <div class="col"></div>
        <input id="count" type="text" class="col" placeholder="Max Rank" style="text-align: center">
        <input id="filter" type="text" class="col" placeholder="Search" style="text-align: center">
        <input id="amount" type="text" class="col" placeholder="Amount" style="text-align: center">
        <div class="col"></div>
        </div>
        <table id="sold" class="table compact table-responsive table-striped table-bordered" style="white-space: nowrap">
            <thead><tr><th>Date</th><th>Stock</th></tr></thead>
        </table>
        <table id="rank" class="table compact table-responsive table-striped table-bordered" style="text-align: center">
            <thead>
                <tr>
                <th colspan=3 rowspan=4></th>
                <th colspan=2>Profitability</th>
                <th colspan=1>Growth</th>
                <th colspan=3>Valuation</th>
                <th colspan=2>Size</th>
                </tr><tr>
                <th id="roce_green"></th>
                <th id="roe_green"></th>
                <th id="sales_green"></th>
                <th id="yield_green"></th>
                <th id="pe_green"></th>
                <th id="ps_green"></th>
                <th id="mcap_green"></th>
                <th id="qsales_green"></th>
                </tr><tr>
                <th id="roce_black"></th>
                <th id="roe_black"></th>
                <th id="sales_black"></th>
                <th id="yield_black"></th>
                <th id="pe_black"></th>
                <th id="ps_black"></th>
                <th id="mcap_black"></th>
                <th id="qsales_black"></th>
                </tr><tr>
                <th id="roce_red"></th>
                <th id="roe_red"></th>
                <th id="sales_red"></th>
                <th id="yield_red"></th>
                <th id="pe_red"></th>
                <th id="ps_red"></th>
                <th id="mcap_red"></th>
                <th id="qsales_red"></th>
                </tr><tr style="position: sticky; top: 0; z-index: 1; background-color: white">
                <th>Rank</th>
                <th>Stock</th>
                <th>Code</th>
                <th>ROCE</th>
                <th>ROE</th>
                <th>Sales</th>
                <th>Yield</th>
                <th>PE</th>
                <th>PS</th>
                <th>MCap</th>
                <th>QSales</th>
                </tr>
            </thead>
        </table>
    </div>
</body>
<script>
const G = {}

fetch('https://magicray.github.io/magicrank.json').then(function(response) {
    response.json().then(function(data) {
        G.data = data
        G.map = data['symbol']

        const age = Math.floor((Date.now() / 1000 - data['date'])/3600)
        const total = G.data['data'].length
	const sell_date = new Date(Math.max(...Object.values(data['sold']))*1000).toJSON()
         $('#timestamp').html(
            '<a href="' + data['url'] + '" target="_blank">Profitable, Growing, Debt Free</a> - ' +
            'Refreshed <a href="">' + age + ' hours</a> ago - ' +
            '<a href="#sold">Recently Sold</a>')

        const sold = {}
        Object.keys(data['sold']).map(function(k) {
            const v = new Date(data['sold'][k]*1000).toJSON().substr(0, 10)
            if(sold[v] == undefined)
                sold[v] = []
            k = k.replaceAll('.', '')
            sold[v].push((G.map[k]? G.map[k]: '') + ' (' + k + ')')
            sold[v].sort()
        })

        $('#sold').dataTable({bPaginate: false, info: false,
            order: [[0, 'desc']],
            data: Object.keys(sold).map(
                k => [k, sold[k].join('<br>')])
        })

        hashchange()
    })
})

function format_data(data, count, amount) {
    const result = []

    for(let i=0; i<count; i++) {
        const d = data[i]
        const cmp = d['cmp_rs']
        const qty = amount? Math.floor(amount/(count*cmp)): ''

        const name = d['name'].replaceAll('.', '')
        const name_html = '<div class="text-nowrap">' + name +
                          '<small> - ' + cmp + (amount > 0? ' * ' + qty: '') + 
                          '</small></div>'

        result.push([
            d['rank'],
            name_html,
            G.map[name]? G.map[name]: '',
            d['roce'],
            d['roe'],
            d['qtr_sales_var'],
            d['earnings_yield'],
            d['p_e'],
            d['p_s']/4,
            d['mar_cap_rs_cr'],
	    d['sales_qtr_rs_cr']])
    }

    return result
}

$('#count').keyup(function(e) {render()})
$('#amount').keyup(function(e) {render()})
$('#filter').keyup(function(e) {G.rank.fnFilter(this.value)})
$(window).on('hashchange', hashchange)

function hashchange(e) {
    if('sold' == location.hash.substr(1)) {
        $('#rank').hide()
        $('#head').hide()
        $('#sold').show()
    } else {
        $('#sold').hide()
        $('#rank').show()
        $('#head').show()
        render()
    }
    $('.dataTables_filter').hide()
}

function render() {
    let count = $('#count').val()
    count = Math.min(G.data['data'].length, count? count: G.data['data'].length)
    renderTable('rank', format_data(G.data['data'], count, $('#amount').val()))
    G.rank.fnFilter($('#filter').val())
    $('.dataTables_filter').hide()
}

function renderTable(tableId, data) {
    function median_index(start_index, end_index) {
        let tmp = end_index - start_index

        return {
            first: start_index + Math.floor((tmp)/2),
            second: start_index + Math.ceil((tmp)/2)
        }
    }

    let median_index_black = median_index(0, data.length-1)
    let data_green = data.slice(0, median_index_black.first+1);
    let data_red = data.slice(median_index_black.second, data.length);

    ['roce', 'roe', 'sales', 'yield', 'pe', 'ps', 'mcap', 'qsales'].map((name, index) => {
	let arr = data_green.map(d => d[index+3]).sort(function(a, b){ return a - b})
        let idx = median_index(0, data_green.length-1)
        $('#' + name + '_green').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_green').css('color', 'Green')
    });

    ['roce', 'roe', 'sales', 'yield', 'pe', 'ps', 'mcap', 'qsales'].map((name, index) => {
	let arr = data_red.map(d => d[index+3]).sort(function(a, b){ return a - b})
        let idx = median_index(0, data_red.length-1)
        $('#' + name + '_red').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_red').css('color', 'Red')
    });

    ['roce', 'roe', 'sales', 'yield', 'pe', 'ps', 'mcap', 'qsales'].map((name, index) => {
	let arr = data.map(d => d[index+3]).sort(function(a, b){ return a - b})
        let idx = median_index(0, arr.length-1)
        $('#' + name + '_black').text(Math.round((arr[idx.first] + arr[idx.second])/2))
    })

    const sort_order = G.rank? G.rank.fnSettings().aaSorting[0]: [0, 'asc']
    $('#' + tableId).dataTable().fnDestroy()

    let tmp = [...data]
    tmp.map((row, index) => {
        for(let i=3; i<12; i++)
            row[i] = Math.round(row[i])
    })

    G.rank = $('#' + tableId).dataTable({bPaginate: false, data: tmp, info: false,
        order: [[sort_order[0], sort_order[1]]],
        rowCallback: function(row, d, i) {
            $(row).css('color', d[0]>tmp.length/2? 'Red': 'Green')
	}})
}
</script>
</html>

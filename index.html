<!doctype html>
<html lang="en">
<head>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
<title>Stocks</title>
</head>
<body>
    <div class="div">
        <p id="timestamp" class="text-center"></p>
        <div id="head" class="row">
        <div class="col"></div>
        <input id="count" type="text" class="col" placeholder="Max Rank" style="text-align: center">
        <input id="filter" type="text" class="col" placeholder="Search" style="text-align: center">
        <input id="amount" type="text" class="col" placeholder="Amount" style="text-align: center">
        <div class="col"></div>
        </div>
        <table id="sold" class="table compact table-responsive table-striped table-bordered" style="white-space: nowrap">
            <thead><tr><th>Date</th><th>Stock</th></tr></thead>
        </table>
        <table id="rank" class="table compact table-responsive table-striped table-bordered" style="text-align: center; font-weight: 500;">
            <thead>
                <tr>
                <th colspan=3>Group</th>
                <th colspan=12>Quality</th>
                <th colspan=11>Growth</th>
                <th colspan=7>Valuation</th>
                <th colspan=5>Stability</th>
                </tr>
                <tr>
                <th colspan=3 id="group_hold">Buy</th>
                <th id="roce_green"></th>
                <th id="roce_3yr_green"></th>
                <th id="roce_5yr_green"></th>
                <th id="roe_green"></th>
                <th id="roe_3yr_green"></th>
                <th id="roe_5yr_green"></th>
                <th id="roic_green"></th>
                <th id="opm_green"></th>
                <th id="opm_5yr_green"></th>
                <th id="roa_green"></th>
                <th id="roa_3yr_green"></th>
                <th id="roa_5yr_green"></th>
                <th id="profit_growth_green"></th>
                <th id="profit_growth_3yr_green"></th>
                <th id="profit_growth_5yr_green"></th>
                <th id="profit_growth_yoy_green"></th>
                <th id="sales_growth_green"></th>
                <th id="sales_growth_3yr_green"></th>
                <th id="sales_growth_5yr_green"></th>
                <th id="sales_growth_yoy_green"></th>
                <th id="oprofit_growth_green"></th>
                <th id="eps_growth_3yr_green"></th>
                <th id="eps_growth_5yr_green"></th>
                <th id="yield_green"></th>
                <th id="pe_green"></th>
                <th id="ps_green"></th>
                <th id="pb_green"></th>
                <th id="po_green"></th>
                <th id="div_yield_green"></th>
                <th id="overbought_green"></th>
                <th id="mcap_green"></th>
                <th id="sales_green"></th>
                <th id="profit_green"></th>
                <th id="oprofit_green"></th>
                <th id="debt2eq_green"></th>
                </tr><tr>
                <th colspan=3 id="group_all">All</th>
                <th id="roce_black"></th>
                <th id="roce_3yr_black"></th>
                <th id="roce_5yr_black"></th>
                <th id="roe_black"></th>
                <th id="roe_3yr_black"></th>
                <th id="roe_5yr_black"></th>
                <th id="roic_black"></th>
                <th id="opm_black"></th>
                <th id="opm_5yr_black"></th>
                <th id="roa_black"></th>
                <th id="roa_3yr_black"></th>
                <th id="roa_5yr_black"></th>
                <th id="profit_growth_black"></th>
                <th id="profit_growth_3yr_black"></th>
                <th id="profit_growth_5yr_black"></th>
                <th id="profit_growth_yoy_black"></th>
                <th id="sales_growth_black"></th>
                <th id="sales_growth_3yr_black"></th>
                <th id="sales_growth_5yr_black"></th>
                <th id="sales_growth_yoy_black"></th>
                <th id="oprofit_growth_black"></th>
                <th id="eps_growth_3yr_black"></th>
                <th id="eps_growth_5yr_black"></th>
                <th id="yield_black"></th>
                <th id="pe_black"></th>
                <th id="ps_black"></th>
                <th id="pb_black"></th>
                <th id="po_black"></th>
                <th id="div_yield_black"></th>
                <th id="overbought_black"></th>
                <th id="mcap_black"></th>
                <th id="sales_black"></th>
                <th id="profit_black"></th>
                <th id="oprofit_black"></th>
                <th id="debt2eq_black"></th>
                </tr><tr>
                <th colspan=3 id="group_avoid">Sell</th>
                <th id="roce_red"></th>
                <th id="roce_3yr_red"></th>
                <th id="roce_5yr_red"></th>
                <th id="roe_red"></th>
                <th id="roe_3yr_red"></th>
                <th id="roe_5yr_red"></th>
                <th id="roic_red"></th>
                <th id="opm_red"></th>
                <th id="opm_5yr_red"></th>
                <th id="roa_red"></th>
                <th id="roa_3yr_red"></th>
                <th id="roa_5yr_red"></th>
                <th id="profit_growth_red"></th>
                <th id="profit_growth_3yr_red"></th>
                <th id="profit_growth_5yr_red"></th>
                <th id="profit_growth_yoy_red"></th>
                <th id="sales_growth_red"></th>
                <th id="sales_growth_3yr_red"></th>
                <th id="sales_growth_5yr_red"></th>
                <th id="sales_growth_yoy_red"></th>
                <th id="oprofit_growth_red"></th>
                <th id="eps_growth_3yr_red"></th>
                <th id="eps_growth_5yr_red"></th>
                <th id="yield_red"></th>
                <th id="pe_red"></th>
                <th id="ps_red"></th>
                <th id="pb_red"></th>
                <th id="po_red"></th>
                <th id="div_yield_red"></th>
                <th id="overbought_red"></th>
                <th id="mcap_red"></th>
                <th id="sales_red"></th>
                <th id="profit_red"></th>
                <th id="oprofit_red"></th>
                <th id="debt2eq_red"></th>
                </tr><tr style="position: sticky; top: 0; z-index: 1; background-color: white">
                <th>Rank</th>
                <th>Stock</th>
                <th>Code</th>
                <th>ROCE</th>
                <th>ROCE 3Yr</th>
                <th>ROCE 5Yr</th>
                <th>ROE</th>
                <th>ROE 3Yr</th>
                <th>ROE 5Yr</th>
                <th>ROIC</th>
                <th>OPM</th>
                <th>OPM 5Yr</th>
                <th>ROA</th>
                <th>ROA 3Yr</th>
                <th>ROA 5Yr</th>
                <th>Profit</th>
                <th>Profit 3Yr</th>
                <th>Profit 5Yr</th>
                <th>Profit YoY</th>
                <th>Sales</th>
                <th>Sales 3Yr</th>
                <th>Sales 5Yr</th>
                <th>Sales YoY</th>
                <th>OProfit</th>
                <th>EPS 3Yr</th>
                <th>EPS 5Yr</th>
                <th>Yield</th>
                <th>PE</th>
                <th>PS</th>
                <th>PB</th>
                <th>PO</th>
                <th>Div Yield</th>
                <th>Over Bought</th>
                <th>MCap</th>
                <th>Sales</th>
                <th>Profit</th>
                <th>OProfit</th>
                <th>Debt/Eq</th>
                </tr>
            </thead>
        </table>
    </div>
</body>
<script>
const G = {}

fetch('https://magicray.github.io/magicrank.json').then(function(response) {
    response.json().then(function(data) {
        G.data = data
        G.map = data['symbol']

        const age = Math.floor((Date.now() / 1000 - data['date'])/3600)
        const total = G.data['data'].length
	const sell_date = new Date(Math.max(...Object.values(data['sold']))*1000).toJSON()
         $('#timestamp').html(
            '<a href="' + data['url'] + '" target="_blank">Quality-Growth-Value-Liquidity</a> - ' +
            'Refreshed <a href="">' + age + ' hours</a> ago - ' +
            '<a href="#sold">Recently Sold</a>')

        const names = data['data'].map(obj => obj['name'])

        const sold = {}
        Object.keys(data['sold']).map(function(k) {
            today = new Date(data['sold'][k]*1000)
            next_sunday = data['sold'][k] + (7 - today.getDay()) * 86400

            if(today.getDay() > 0 && new Date(next_sunday*1000) <= new Date())
                today = new Date(next_sunday*1000)
            else
                today = new Date(data['sold'][k]*1000)

            const v = today.toJSON().substr(0, 10) + " " + today.toString().substr(0, 4)
            if(sold[v] == undefined)
                sold[v] = []
            k = k.replaceAll('.', '')

            if(names.includes(k))
                sold[v].push((G.map[k]? G.map[k]: '') + ' (' + k + ')')
            else
                sold[v].push('<strong>' + (G.map[k]? G.map[k]: '') + ' (' + k + ')</strong>')

            sold[v].sort()
        })

        $('#sold').dataTable({bPaginate: false, info: false,
            order: [[0, 'desc']],
            data: Object.keys(sold).map(
                k => [k, sold[k].join('<br>')])
        })

        hashchange()
    })
})

function format_data(data, count, amount) {
    const result = []

    for(let i=0; i<count; i++) {
        const d = data[i]
        const cmp = d['cmp_rs']
        const qty = amount? Math.floor(amount/(count*cmp)): ''

        const name = d['name'].replaceAll('.', '')
        const name_html = '<div class="text-nowrap">' + name +
                          '<small> - ' + cmp + (amount > 0? ' * ' + qty: '') + 
                          '</small></div>'

        result.push([
            d['rank'],
            name_html,
            G.map[name]? G.map[name]: '',
            d['roce'],
            d['roce_3yr'],
            d['roce_5yr'],
            d['roe'],
            d['roe_3yr'],
            d['roe_5yr'],
            d['roic'],
            d['opm'],
            d['5yr_opm'],
            d['roa_12m'],
            d['roa_3yr'],
            d['roa_5yr'],
            d['profit_growth'],
            d['profit_var_3yrs'],
            d['profit_var_5yrs'],
            d['qtr_profit_var'],
            d['sales_growth'],
            d['sales_var_3yrs'],
            d['sales_var_5yrs'],
            d['qtr_sales_var'],
            d['opert_prft_gwth'],
            d['eps_var_3yrs'],
            d['eps_var_5yrs'],
            d['earnings_yield'],
            d['p_e'],
            d['cmp_sales'],
            d['cmp_bv'],
            d['p_o'],
            d['div_yield'],
            d['overbought'],
            d['mar_cap_rs_cr'],
	    d['sales_rs_cr'],
	    d['np_12m_rs_cr'],
	    d['op_12m_rs_cr'],
	    d['debt_eq']])
    }

    return result
}

$('#count').keyup(function(e) {render()})
$('#amount').keyup(function(e) {render()})
$('#filter').keyup(function(e) {G.rank.fnFilter(this.value)})
$(window).on('hashchange', hashchange)

function hashchange(e) {
    if('sold' == location.hash.substr(1)) {
        $('#rank').hide()
        $('#head').hide()
        $('#sold').show()
    } else {
        $('#sold').hide()
        $('#rank').show()
        $('#head').show()
        render()
    }
    $('.dataTables_filter').hide()
}

function render() {
    let count = $('#count').val()
    count = Math.min(G.data['data'].length, count? count: G.data['data'].length)
    renderTable('rank', format_data(G.data['data'], count, $('#amount').val()))
    G.rank.fnFilter($('#filter').val())
    $('.dataTables_filter').hide()
}

function renderTable(tableId, data) {
    function median_index(start_index, end_index) {
        let tmp = end_index - start_index

        return {
            first: start_index + Math.floor((tmp)/2),
            second: start_index + Math.ceil((tmp)/2)
        }
    }

    let median_index_black = median_index(0, data.length-1)
    let max_dark_len = Math.floor(data.length/4)

    let data_dark = data.slice(0, max_dark_len);
    let data_green = data.slice(0, median_index_black.first+1);
    let data_red = data.slice(median_index_black.second, data.length);

    // $("#group_buy").html("Buy (top " + max_dark_len + ")");
    $("#group_hold").html("Buy (top " + data_green.length + ")");
    $("#group_all").html("All (" + data.length + ")");
    $("#group_avoid").html("Sell (bottom " + data_red.length + ")");

    $("#group_hold").css("color", "green");
    $("#group_hold").css("font-weight", "normal");
    $("#group_all").css("font-weight", "normal");
    $("#group_avoid").css("color", "red");
    $("#group_avoid").css("font-weight", "normal");

    const col = ['roce', 'roce_3yr', 'roce_5yr', 'roe', 'roe_3yr', 'roe_5yr',
                 'roic', 'opm', 'opm_5yr', 'roa', 'roa_3yr', 'roa_5yr',
	         'profit_growth', 'profit_growth_3yr', 'profit_growth_5yr', 'profit_growth_yoy',
                 'sales_growth', 'sales_growth_3yr', 'sales_growth_5yr', 'sales_growth_yoy',
                 'oprofit_growth', 'eps_growth_3yr', 'eps_growth_5yr',
	         'yield', 'pe', 'ps', 'pb', 'po', 'div_yield', 'overbought',
	         'mcap', 'sales', 'profit', 'oprofit', 'debt2eq']

    col.map((name, index) => {
	let arr = data_green.map(d => d[index+3]).sort(function(a, b){ return a - b})
        let idx = median_index(0, data_green.length-1)
        $('#' + name + '_green').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_green').css('color', 'Green')
        $('#' + name + '_green').css('font-weight', 'normal')
    });

    col.map((name, index) => {
	let arr = data_red.map(d => d[index+3]).sort(function(a, b){ return a - b})
        let idx = median_index(0, data_red.length-1)
        $('#' + name + '_red').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_red').css('color', 'Red')
        $('#' + name + '_red').css('font-weight', 'normal')
    });

    col.map((name, index) => {
	let arr = data.map(d => d[index+3]).sort(function(a, b){ return a - b})
        let idx = median_index(0, arr.length-1)
        $('#' + name + '_black').text(Math.round((arr[idx.first] + arr[idx.second])/2))
        $('#' + name + '_black').css('font-weight', 'normal')
    })

    const sort_order = G.rank? G.rank.fnSettings().aaSorting[0]: [0, 'asc']
    $('#' + tableId).dataTable().fnDestroy()

    let tmp = [...data]
    tmp.map((row, index) => {
        for(let i=3; i<38; i++)
            row[i] = Math.round(row[i])
    })

    G.rank = $('#' + tableId).dataTable({bPaginate: false, data: tmp, info: false,
        order: [[sort_order[0], sort_order[1]]],
        rowCallback: function(row, d, i) {
            $(row).css('color', d[0]>tmp.length/2? 'Red': 'Green')
	}})
}
</script>
</html>
